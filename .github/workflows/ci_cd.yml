name: GitHub CI CD
on:
  pull_request:
    # GitHub default types + ready_for_review to trigger the workflow on PRs no longer in draft mode.
    # See https://github.com/ansys/pyaedt/issues/5223 for more information
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
  push:
    tags:
      - "*"
    branches:
      - main

env:
  ANSYSLMD_LICENSE_FILE: ${{ format('1055@{0}', secrets.LICENSE_SERVER) }}
  MAIN_PYTHON_VERSION: '3.10'
  PACKAGE_NAME: 'PyAEDT'
  DOCUMENTATION_CNAME: 'aedt.docs.pyansys.com'
  ON_CI: True
  PYTEST_ARGUMENTS: '-vvv --color=yes -ra --durations=25 --maxfail=10 --cov=ansys.aedt.core --cov-report=html --cov-report=xml --junitxml=junit/test-results.xml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # doc-build-win:
  #   name: Documentation build windows
  #   runs-on: windows-latest
  #   steps:
  #     - name: Documentation build
  #       uses: ansys/actions/doc-build@main
  #       with:
  #         python-version: ${{ env.MAIN_PYTHON_VERSION }}
  #         sphinxopts: '-j auto --color -w build_errors.txt'
  #         check-links: false
  #         needs-quarto: true

  # doc-build-ubuntu:
  #   name: Documentation build ubuntu
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Documentation build
  #       uses: ansys/actions/doc-build@main
  #       with:
  #         dependencies: "graphviz texlive-latex-extra latexmk texlive-xetex texlive-fonts-extra"
  #         python-version: ${{ env.MAIN_PYTHON_VERSION }}
  #         sphinxopts: '-j auto --color -w build_errors.txt'
  #         check-links: false
  #         needs-quarto: true

  test-awalsh:
    name: Test awalsh
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # - uses: awalsh128/cache-apt-pkgs-action@7ca5f46d061ad9aa95863cd9b214dd48edef361d
      - uses: SMoraisAnsys/cache-apt-pkgs-action@test/debug-action
        with:
          # packages: dia doxygen doxygen-doc doxygen-gui doxygen-latex graphviz mscgen
          # packages: graphviz texlive-latex-extra latexmk texlive-xetex texlive-fonts-extra
          # packages: graphviz texlive-latex-extra 
          packages: graphviz texlive-latex-extra latexmk
          # latexmk texlive-xetex
          version: 1.0

  test-install-packages:
    name: Test install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install packages
        run: |
          sudo apt-get update
          echo "test latexmk"
          # sudo apt-get install -y latexmk
          apt-cache --quiet=0 --no-all-versions show latexmk
          # echo "test textlive-xetex"
          # sudo apt-get install -y texlive-xetex
          # echo "test texlive-fonts-extra"
          # sudo apt-get install -y texlive-fonts-extra