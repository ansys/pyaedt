name: Update Testmon Cache on Merge

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  TESTMON_DATAFILE: '.testmondata'
  TESTMON_CACHE_KEY_UNIT_LINUX: 'testmondata-unit-linux'
  TESTMON_CACHE_KEY_INTEGRATION_LINUX: 'testmondata-integration-linux'
  TESTMON_CACHE_KEY_SOLVERS_WIN: 'testmondata-solvers-win'
  TESTMON_CACHE_KEY_SOLVERS_LINUX: 'testmondata-solvers-linux'
  TESTMON_CACHE_KEY_GENERAL_WIN: 'testmondata-general-win'
  TESTMON_CACHE_KEY_GENERAL_LINUX: 'testmondata-general-linux'
  TESTMON_CACHE_KEY_VISUALIZATION_WIN: 'testmondata-visualization-win'
  TESTMON_CACHE_KEY_VISUALIZATION_LINUX: 'testmondata-visualization-linux'
  TESTMON_CACHE_KEY_ICEPAK_WIN: 'testmondata-icepak-win'
  TESTMON_CACHE_KEY_ICEPAK_LINUX: 'testmondata-icepak-linux'
  TESTMON_CACHE_KEY_LAYOUT_WIN: 'testmondata-layout-win'
  TESTMON_CACHE_KEY_LAYOUT_LINUX: 'testmondata-layout-linux'
  TESTMON_CACHE_KEY_EXTENSIONS_WIN: 'testmondata-extensions-win'
  TESTMON_CACHE_KEY_EXTENSIONS_LINUX: 'testmondata-extensions-linux'
  TESTMON_CACHE_KEY_FILTER_WIN: 'testmondata-filter-win'
  TESTMON_CACHE_KEY_EMIT_WIN: 'testmondata-emit-win'

jobs:
  update-cache:
    name: Update testmon cache on main branch
    runs-on: ubuntu-latest
    permissions:
      actions: read        # Required to list workflow runs and artifacts
      contents: write      # Required to save cache
      pull-requests: read  # Required to read PR information
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Identify Source PR and Run ID
        id: find_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ github.sha }}
          WORKFLOW_NAME: "GitHub CI CD"
        run: |
          # Find the PR number associated with this merge commit
          pr_number=$(git log -1 --pretty=%B | grep -oP '(?<=#)\d+(?=\s+from)' | head -n 1)

          if [ -z "$pr_number" ]; then
            echo "⚠️ No merged PR found for commit $COMMIT_SHA"
            echo "pr_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "✅ Found merged PR #$pr_number"
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
          echo "pr_found=true" >> $GITHUB_OUTPUT

          # Find the workflow run ID for the PR
          run_id=$(gh run list \
            --workflow="$WORKFLOW_NAME" \
            --json databaseId,headBranch,event \
            --jq ".[] | select(.event == \"pull_request\") | select(.headBranch != \"main\") | .databaseId" | head -n 1)

          if [ -z "$run_id" ]; then
            echo "⚠️ No workflow run found for PR #$pr_number"
            echo "pr_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "✅ Found workflow run ID: $run_id"
          echo "run_id=$run_id" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # UNIT TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Unit Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-unit-linux
          path: unit-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Unit Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f unit-linux-data/.testmondata ]; then
            mv unit-linux-data/.testmondata .testmondata
            echo "Unit Linux testmondata found and copied"
          else
            echo "No Unit Linux testmondata artifact found"
            exit 0
          fi

      - name: Upload Unit Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_UNIT_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # INTEGRATION TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Integration Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-integration-linux
          path: integration-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Integration Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f integration-linux-data/.testmondata ]; then
            mv integration-linux-data/.testmondata .testmondata
            echo "Integration Linux testmondata found and copied"
          else
            echo "No Integration Linux testmondata artifact found"
            exit 0
          fi

      - name: Upload Integration Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_INTEGRATION_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # SOLVERS TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Solvers Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-solvers-win
          path: solvers-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Solvers Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f solvers-win-data/.testmondata ]; then
            mv solvers-win-data/.testmondata .testmondata
            echo "Solvers Windows testmondata found and copied"
          else
            echo "No Solvers Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload Solvers Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_SOLVERS_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # SOLVERS TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Solvers Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-solvers-linux
          path: solvers-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Solvers Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f solvers-linux-data/.testmondata ]; then
            mv solvers-linux-data/.testmondata .testmondata
            echo "Solvers Linux testmondata found and copied"
          else
            echo "No Solvers Linux testmondata artifact found"
            exit 0
          fi

      - name: Upload Solvers Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_SOLVERS_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # GENERAL TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download General Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-general-win
          path: general-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save General Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f general-win-data/.testmondata ]; then
            mv general-win-data/.testmondata .testmondata
            echo "General Windows testmondata found and copied"
          else
            echo "No General Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload General Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_GENERAL_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # GENERAL TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download General Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-general-linux
          path: general-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save General Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f general-linux-data/.testmondata ]; then
            mv general-linux-data/.testmondata .testmondata
            echo "General Linux testmondata found and copied"
          else
            echo "No General Linux testmondata artifact found"
            exit 0
          fi

      - name: Upload General Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_GENERAL_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # VISUALIZATION TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Visualization Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-visualization-win
          path: visualization-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Visualization Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f visualization-win-data/.testmondata ]; then
            mv visualization-win-data/.testmondata .testmondata
            echo "Visualization Windows testmondata found and copied"
          else
            echo "No Visualization Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload Visualization Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_VISUALIZATION_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # VISUALIZATION TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Visualization Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-visualization-linux
          path: visualization-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Visualization Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f visualization-linux-data/.testmondata ]; then
            mv visualization-linux-data/.testmondata .testmondata
            echo "Visualization Linux testmondata found and copied"
          else
            echo "::warning::No Visualization Linux testmondata artifact found"
          fi

      - name: Upload Visualization Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_VISUALIZATION_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # ICEPAK TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Icepak Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-icepak-win
          path: icepak-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Icepak Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f icepak-win-data/.testmondata ]; then
            mv icepak-win-data/.testmondata .testmondata
            echo "Icepak Windows testmondata found and copied"
          else
            echo "::warning::No Icepak Windows testmondata artifact found"
          fi

      - name: Upload Icepak Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_ICEPAK_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # ICEPAK TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Icepak Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-icepak-linux
          path: icepak-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Icepak Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f icepak-linux-data/.testmondata ]; then
            mv icepak-linux-data/.testmondata .testmondata
            echo "Icepak Linux testmondata found and copied"
          else
            echo "::warning::No Icepak Linux testmondata artifact found"
          fi

      - name: Upload Icepak Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_ICEPAK_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # LAYOUT TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Layout Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-layout-win
          path: layout-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Layout Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f layout-win-data/.testmondata ]; then
            mv layout-win-data/.testmondata .testmondata
            echo "Layout Windows testmondata found and copied"
          else
            echo "No Layout Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload Layout Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_LAYOUT_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # LAYOUT TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Layout Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-layout-linux
          path: layout-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Layout Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f layout-linux-data/.testmondata ]; then
            mv layout-linux-data/.testmondata .testmondata
            echo "Layout Linux testmondata found and copied"
          else
            echo "No Layout Linux testmondata artifact found"
            exit 0
          fi

      - name: Upload Layout Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_LAYOUT_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # EXTENSIONS TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Extensions Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-extensions-win
          path: extensions-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Extensions Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f extensions-win-data/.testmondata ]; then
            mv extensions-win-data/.testmondata .testmondata
            echo "Extensions Windows testmondata found and copied"
          else
            echo "No Extensions Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload Extensions Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_EXTENSIONS_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # EXTENSIONS TESTS CACHE UPDATE (LINUX)
      # ------------------------------------------------------------------
      - name: Download Extensions Test Artifacts (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-extensions-linux
          path: extensions-linux-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Extensions Test Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f extensions-linux-data/.testmondata ]; then
            mv extensions-linux-data/.testmondata .testmondata
            echo "Extensions Linux testmondata found and copied"
          else
            echo "No Extensions Linux testmondata artifact found"
            exit 0
          fi

      - name: Upload Extensions Test Cache to GitHub Cache (Linux)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_EXTENSIONS_LINUX }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # FILTER TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Filter Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-filter-win
          path: filter-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Filter Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f filter-win-data/.testmondata ]; then
            mv filter-win-data/.testmondata .testmondata
            echo "Filter Windows testmondata found and copied"
          else
            echo "No Filter Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload Filter Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_FILTER_WIN }}-main-${{ github.sha }}

      # ------------------------------------------------------------------
      # EMIT TESTS CACHE UPDATE (WINDOWS)
      # ------------------------------------------------------------------
      - name: Download Emit Test Artifacts (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: testmondata-emit-win
          path: emit-win-data
          run-id: ${{ steps.find_info.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Save Emit Test Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true'
        run: |
          if [ -f emit-win-data/.testmondata ]; then
            mv emit-win-data/.testmondata .testmondata
            echo "Emit Windows testmondata found and copied"
          else
            echo "No Emit Windows testmondata artifact found"
            exit 0
          fi

      - name: Upload Emit Test Cache to GitHub Cache (Windows)
        if: steps.find_info.outputs.pr_found == 'true' && hashFiles('.testmondata') != ''
        uses: actions/cache/save@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.TESTMON_DATAFILE }}
          key: ${{ env.TESTMON_CACHE_KEY_EMIT_WIN }}-main-${{ github.sha }}