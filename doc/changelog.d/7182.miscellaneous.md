Improve typing and add return types
